package data_access;

import entity.Event;
import entity.EventCategory;
import entity.Location;
import org.json.JSONArray;
import org.json.JSONObject;

import java.io.*;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;

/**
 * File-based data access object for saving and loading user's saved events.
 * Each user's saved events are stored in a separate JSON file.
 */
public class FileSavedEventsDataAccessObject {

    private static final String SAVED_EVENTS_DIR = "saved_events";
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ISO_LOCAL_DATE_TIME;

    /**
     * Constructor that creates the saved_events directory if it doesn't exist.
     */
    public FileSavedEventsDataAccessObject() {
        File directory = new File(SAVED_EVENTS_DIR);
        if (!directory.exists()) {
            directory.mkdirs();
        }
    }

    /**
     * Save an event for a specific user.
     * @param username the username
     * @param event the event to save
     */
    public void saveEvent(String username, Event event) {
        List<Event> savedEvents = getSavedEvents(username);

        // Check if event already exists (by ID)
        boolean exists = savedEvents.stream()
                .anyMatch(e -> e.getId().equals(event.getId()));

        if (!exists) {
            savedEvents.add(event);
            writeEventsToFile(username, savedEvents);
        }
    }

    /**
     * Remove an event for a specific user.
     * @param username the username
     * @param event the event to remove
     */
    public void removeEvent(String username, Event event) {
        List<Event> savedEvents = getSavedEvents(username);
        savedEvents.removeIf(e -> e.getId().equals(event.getId()));
        writeEventsToFile(username, savedEvents);
    }

    /**
     * Get all saved events for a specific user.
     * @param username the username
     * @return list of saved events
     */
    public List<Event> getSavedEvents(String username) {
        File file = new File(SAVED_EVENTS_DIR, username + "_events.json");

        if (!file.exists()) {
            return new ArrayList<>();
        }

        try {
            String content = new String(Files.readAllBytes(Paths.get(file.getPath())));
            JSONArray jsonArray = new JSONArray(content);

            List<Event> events = new ArrayList<>();
            for (int i = 0; i < jsonArray.length(); i++) {
                JSONObject eventJson = jsonArray.getJSONObject(i);
                Event event = parseEventFromJson(eventJson);
                if (event != null) {
                    events.add(event);
                }
            }
            return events;

        } catch (IOException e) {
            System.err.println("Error reading saved events for user " + username + ": " + e.getMessage());
            return new ArrayList<>();
        }
    }

    /**
     * Check if an event is saved for a specific user.
     * @param username the username
     * @param eventId the event ID
     * @return true if the event is saved
     */
    public boolean isEventSaved(String username, String eventId) {
        List<Event> savedEvents = getSavedEvents(username);
        return savedEvents.stream().anyMatch(e -> e.getId().equals(eventId));
    }

    /**
     * Clear all saved events for a specific user.
     * @param username the username
     */
    public void clearAllEvents(String username) {
        File file = new File(SAVED_EVENTS_DIR, username + "_events.json");
        if (file.exists()) {
            file.delete();
        }
    }

    /**
     * Write events to file for a specific user.
     */
    private void writeEventsToFile(String username, List<Event> events) {
        File file = new File(SAVED_EVENTS_DIR, username + "_events.json");

        try (BufferedWriter writer = new BufferedWriter(new FileWriter(file))) {
            JSONArray jsonArray = new JSONArray();

            for (Event event : events) {
                JSONObject eventJson = convertEventToJson(event);
                jsonArray.put(eventJson);
            }

            writer.write(jsonArray.toString(4)); // Pretty print with 4-space indent

        } catch (IOException e) {
            System.err.println("Error writing saved events for user " + username + ": " + e.getMessage());
        }
    }

    /**
     * Convert an Event object to JSON.
     */
    private JSONObject convertEventToJson(Event event) {
        JSONObject json = new JSONObject();
        json.put("id", event.getId());
        json.put("name", event.getName());
        json.put("description", event.getDescription());
        json.put("category", event.getCategory().name());
        json.put("imageUrl", event.getImageUrl());
        json.put("startTime", event.getStartTime().format(DATE_FORMATTER));

        // Location
        JSONObject locationJson = new JSONObject();
        locationJson.put("address", event.getLocation().getAddress());
        locationJson.put("latitude", event.getLocation().getLatitude());
        locationJson.put("longitude", event.getLocation().getLongitude());
        json.put("location", locationJson);

        return json;
    }

    /**
     * Parse an Event object from JSON.
     */
    private Event parseEventFromJson(JSONObject json) {
        try {
            String id = json.getString("id");
            String name = json.getString("name");
            String description = json.getString("description");
            EventCategory category = EventCategory.valueOf(json.getString("category"));
            String imageUrl = json.getString("imageUrl");
            LocalDateTime startTime = LocalDateTime.parse(json.getString("startTime"), DATE_FORMATTER);

            JSONObject locationJson = json.getJSONObject("location");
            Location location = new Location(
                locationJson.getString("address"),
                locationJson.getDouble("latitude"),
                locationJson.getDouble("longitude")
            );

            return new Event(id, name, description, category, location, startTime, imageUrl);

        } catch (Exception e) {
            System.err.println("Error parsing event from JSON: " + e.getMessage());
            return null;
        }
    }
}